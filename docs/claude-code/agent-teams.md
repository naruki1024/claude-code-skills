# Agent Teams - Claude Code セッションのチーム協調

> 複数のClaude Codeインスタンスをチームとして協調させ、共有タスク、エージェント間メッセージング、集中管理を行う。

## ステータス

**実験的機能** - デフォルトで無効。`settings.json` の `env` に `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS: "1"` を設定して有効化。

## 概要

Agent Teamsは複数のClaude Codeインスタンスの協調を可能にする。1つのセッションがチームリードとして作業を調整・割当・統合し、チームメイトは独立して作業しつつ直接通信する。

## サブエージェントとの比較

| 観点 | サブエージェント | Agent Teams |
|------|-----------------|-------------|
| コンテキスト | 独自ウィンドウ、結果を呼び出し元に返す | 独自ウィンドウ、完全に独立 |
| 通信 | メインエージェントへの結果報告のみ | チームメイト同士が直接メッセージ |
| 調整 | メインエージェントが全作業を管理 | 共有タスクリストで自己調整 |
| 最適用途 | 結果のみ必要な集中タスク | 議論・協調が必要な複雑な作業 |
| トークン | 低い（結果をサマリー化） | 高い（各メンバーが独立インスタンス） |

## 有効化

```json
// .claude/settings.json
{
  "env": {
    "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1"
  },
  "teammateMode": "auto"
}
```

`teammateMode` オプション:
- `"auto"` (デフォルト): tmuxセッション内ならスプリットペイン、それ以外はインプロセス
- `"in-process"`: 全メンバーがメインターミナル内で動作
- `"tmux"`: スプリットペインモード（tmux or iTerm2が必要）

## チームの開始

自然言語でチーム構成とタスクを記述する：

```
CLIツールのTODOコメント追跡機能を設計する。
UX担当、技術アーキテクチャ担当、批判的検討担当の3人のチームを作成して。
```

Claudeがチームを作成し、メンバーを起動し、作業を調整する。

## チームの操作

### 表示モード

- **インプロセス**: Shift+Up/Downでメンバー選択、直接メッセージ送信
- **スプリットペイン**: 各メンバーが独自のペインを持つ（tmux/iTerm2必要）

### メンバーとモデルの指定

```
4人のメンバーでこれらのモジュールを並行リファクタリングして。
各メンバーにはSonnetを使用。
```

### 計画承認の要求

```
認証モジュールのリファクタリングのためにアーキテクトメンバーを起動して。
変更前に計画承認を必須にして。
```

メンバーが計画完了後、リードに承認リクエストを送信。リードが承認/却下を判断。

### デリゲートモード

Shift+Tabでデリゲートモードに切替。リードを調整専任に制限（コード変更不可）：
- メンバーの起動・メッセージ・停止
- タスク管理
- 作業の統合

### メンバーへの直接メッセージ

- **インプロセス**: Shift+Up/Downでメンバー選択 → メッセージ入力
- **スプリットペイン**: メンバーのペインをクリック

### タスクの割当と自己取得

共有タスクリストで作業を調整：
- **リードが割当**: 特定タスクを特定メンバーに割当
- **自己取得**: メンバーが完了後、次の未割当・未ブロックタスクを自動取得

タスク状態: pending → in_progress → completed
タスク間の依存関係もサポート。

### メンバーの停止

```
リサーチャーメンバーにシャットダウンを依頼して
```

### チームのクリーンアップ

```
チームをクリーンアップして
```

注意: 必ずリードからクリーンアップを実行すること。

## アーキテクチャ

| コンポーネント | 役割 |
|--------------|------|
| チームリード | チーム作成、メンバー起動、作業調整するメインセッション |
| チームメイト | 各タスクに取り組む独立したClaude Codeインスタンス |
| タスクリスト | メンバーが取得・完了する共有作業リスト |
| メールボックス | エージェント間通信のメッセージングシステム |

保存先:
- チーム設定: `~/.claude/teams/{team-name}/config.json`
- タスクリスト: `~/.claude/tasks/{team-name}/`

## 権限

メンバーはリードの権限設定を継承。リードが `--dangerously-skip-permissions` で実行中なら、全メンバーも同様。起動後に個別変更可能。

## コンテキストと通信

- メンバーは独自のコンテキストウィンドウを持つ
- 起動時にCLAUDE.md、MCPサーバー、スキルを読み込む
- **リードの会話履歴は引き継がれない**
- 自動メッセージ配信、アイドル通知、共有タスクリスト

## ベストプラクティス

### 十分なコンテキストを与える

```
セキュリティレビューメンバーを起動。プロンプト: "src/auth/ の認証モジュールの
セキュリティ脆弱性をレビュー。トークン処理、セッション管理、入力検証に焦点。
アプリはhttpOnlyクッキーに保存されたJWTトークンを使用。
深刻度付きで問題を報告。"
```

### タスクサイズの適正化

- **小さすぎ**: 調整オーバーヘッドが利益を上回る
- **大きすぎ**: チェックインなしで長時間作業、無駄なリスク増大
- **適切**: 明確な成果物を生む自己完結型の単位（関数、テストファイル、レビュー）
- 目安: 1メンバーあたり5-6タスク

### ファイル競合の回避

2人のメンバーが同じファイルを編集すると上書きが発生。各メンバーに異なるファイルセットを担当させる。

### 監視とステアリング

メンバーの進捗を確認し、うまくいかないアプローチをリダイレクトし、発見を随時統合する。

## ユースケース例

### 並行コードレビュー

```
PR #142をレビューするチームを作成。3人のレビューアー:
- セキュリティ影響に集中
- パフォーマンス影響をチェック
- テストカバレッジを検証
各自レビューして結果を報告。
```

### 競合仮説による調査

```
ユーザーが1メッセージ後にアプリが終了すると報告。
5人のエージェントメンバーで異なる仮説を調査。互いに相手の理論を
反証しようとする科学的討論のように対話させて。
合意が得られたらfindings docを更新。
```

## 制限事項

- インプロセスメンバーのセッション再開は不可（/resume、/rewindは復元しない）
- タスクステータスが遅延する場合あり
- シャットダウンが遅い場合あり（現在のリクエスト完了を待つ）
- 1セッション1チーム
- ネストされたチームは不可（メンバーは自身のチームを作成できない）
- リードは固定（昇格・移譲不可）
- 権限は起動時に設定（起動後に個別変更は可能）
- スプリットペインはtmux/iTerm2が必要

## 参照

- 公式ドキュメント: https://code.claude.com/docs/en/agent-teams.md
- サブエージェント: https://code.claude.com/docs/en/sub-agents.md
- 機能比較: https://code.claude.com/docs/en/features-overview.md
