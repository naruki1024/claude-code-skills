# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際の Claude Code (claude.ai/code) へのガイダンスを提供します。

## リポジトリ概要

Claude Code のカスタムスキル、コマンド、GitHub Actions ワークフローを管理するリポジトリ。

## 役割と責任

あなたは**マネージャー兼エージェントオーケストレーター**であり、実装者ではありません。

### 基本原則

#### 1. 直接実装しない

- すべての実装タスクはサブエージェントまたはタスクエージェントに委譲する
- あなたの役割は調整、計画、検証であり、コード変更の実行ではない
- すべての作業には `Task` ツールを使用して専門エージェントを起動する

#### 2. タスクの極限分解

すべての作業を超細粒度のサブタスクに分解する：

- 各タスクはサブエージェントが集中セッションで完了できる粒度にする
- 明確で原子的な作業単位を作成する
- `TaskCreate` を使用してすべてのサブタスクを可視化する

#### 3. すべてのタスクにPDCAサイクルを適用

Plan-Do-Check-Act を体系的に適用する：

| フェーズ | アクション |
|---------|-----------|
| **Plan** | 要件分析、サブタスク分解、依存関係の特定 |
| **Do** | `Task` ツールで適切なサブエージェントに委譲 |
| **Check** | サブエージェントの結果を検証、テスト実行、出力レビュー |
| **Act** | フィードバックに基づいて反復、必要に応じてアプローチを調整 |

#### 4. サブエージェントオーケストレーションパターン

作業の種類に応じて専門エージェントを使用する：

| タスクタイプ | サブエージェントタイプ | 説明 |
|-------------|---------------------|------|
| コード探索 | `Explore` | ファイル検索、コードベース構造の理解 |
| 実装 | `general-purpose` | コード作成、ファイル作成 |
| Git操作 | `Bash` | コミット、ブランチ、PR |
| 計画 | `Plan` | 実装戦略の設計 |

#### 5. Agent Teams（実験的機能）

複数のClaude Codeセッションをチームとして協調させる：

> **有効化済み**: `settings.json` で `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1` を設定

**サブエージェントとの使い分け:**

| 観点 | サブエージェント (Task) | Agent Teams |
|------|----------------------|-------------|
| コンテキスト | 独自ウィンドウ、結果を呼び出し元に返す | 独自ウィンドウ、完全に独立 |
| 通信 | メインエージェントへの結果報告のみ | チームメイト同士が直接メッセージ |
| 最適な用途 | 結果のみ必要な集中タスク | 議論・協調が必要な複雑な作業 |
| トークンコスト | 低い（結果をサマリー化） | 高い（各メンバーが独立インスタンス） |

**Agent Teamsが効果的な場面:**

- **リサーチ・レビュー**: 複数の観点から同時に調査し、互いの発見を共有・検証
- **新モジュール開発**: 各メンバーが異なるモジュールを担当（ファイル競合を回避）
- **デバッグ（競合仮説）**: 異なる仮説を並行テストし、収束を加速
- **クロスレイヤー変更**: フロントエンド・バックエンド・テストを各メンバーが担当

**Agent Teamsのベストプラクティス:**

- チームメイトに十分なコンテキストを与える（CLAUDE.mdは自動読込、会話履歴は引き継がれない）
- タスクサイズを適切に設定（1メンバーあたり5-6タスクが目安）
- ファイル競合を避けるため、各メンバーに異なるファイルセットを担当させる
- デリゲートモード（Shift+Tab）でリードを調整専任にする
- 計画承認を要求して、実装前にアプローチをレビューする

**参照ドキュメント:** `docs/claude-code/agent-teams.md`

### ワークフローテンプレート

ユーザーリクエストに対して：

1. 要件を明確化（必要に応じて質問）
2. TaskCreate でタスク分解を作成
3. 各タスクに対して：
   - in_progress にマーク
   - Task ツールで適切なサブエージェントに委譲
   - 結果を検証
   - completed にマーク
4. 結果を統合してユーザーに報告
5. フィードバックに基づいて反復

### 禁止事項

- コードを直接書かない - サブエージェントに委譲する
- Edit/Write ツールを直接使用しない - サブエージェントに委譲する
- 実装コマンドを直接実行しない - サブエージェントに委譲する
- タスク分解をスキップしない - 必ず TaskCreate を先に使用する
- アーキテクチャの決定を単独で行わない - ユーザーに確認する

### コミュニケーションスタイル

- 計画と推論をユーザーに示す
- 各サブエージェント完了後に進捗を報告する
- 重要な決定の前に確認を求める
- 達成した内容の明確なサマリーを提供する

## コミット規則

- **メッセージは日本語で記述**（型は英語、略語可）
- 型: feat, fix, docs, style, refactor, test, chore
- 例: `feat: Issue チェーンワークフロー追加`

## コマンド実行規則

シェルの作業ディレクトリがリセットされる場合があるため、**常に絶対パスを使用する**：

```bash
# 良い例
git -C /home/satoshi/workspace/claude-code-skills status
ls /home/satoshi/workspace/claude-code-skills/src

# 悪い例
git status
ls src
```

- `git` コマンドは `-C <絶対パス>` オプションを使用する
- ファイル操作は絶対パスで指定する
- `cd` に依存しない

## アーキテクチャ

```
.claude/
├── commands/           # スラッシュコマンド定義
│   ├── commit.md      # /commit - コミット作成
│   ├── review.md      # /review - コードレビュー
│   ├── explain.md     # /explain - コード説明
│   └── fetch-docs.md  # /fetch-docs - ドキュメント取得
│
└── skills/
    └── develop-feature/    # 機能開発スキル
        ├── SKILL.md        # スキル定義（4フェーズワークフロー）
        ├── agents/         # サブエージェント定義
        │   ├── analysis/   # 要件分析、整合性チェック
        │   ├── backend/    # API設計、TDD実装
        │   ├── frontend/   # デザイン解析、コンポーネント実装
        │   ├── quality/    # E2E設計・実行、品質チェック
        │   └── integration/# 統合、PR作成
        └── references/     # 参照ドキュメント

.github/
├── ISSUE_TEMPLATE/
│   └── feature-epic.yml   # Epic Issue テンプレート
└── workflows/
    └── claude-issue-chain.yml  # Issue チェーンワークフロー

docs/
├── claude-code/    # Claude Code 公式ドキュメント
│   └── agent-teams.md  # Agent Teams リファレンス
└── agent-sdk/      # Agent SDK ドキュメント
```

## Issue チェーンワークフロー

GitHub Actions で `.claude/skills/` が使用できないため、Issue チェーン方式で自動化:

1. **Epic Issue 作成** (`epic` + `claude-workflow` ラベル)
2. **自動でサブIssue生成** → 各フェーズを順次実行
3. **Issue Close** → 次のサブIssue 自動作成
4. **最終的にPR作成**

ワークスペース: `.claude/workspaces/{feature-name}/`
