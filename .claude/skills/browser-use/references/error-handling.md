# エラー処理ガイド

## 一般的なエラーと対処

### 1. 要素が見つからない (Element Not Found)

**原因:**
- セレクタが間違っている
- 要素がまだ読み込まれていない
- 要素が動的に生成される
- 要素がビューポート外にある

**対処:**
```
1. browser_snapshot を再取得
2. 要素の ref 値を確認
3. browser_wait_for で要素の出現を待機
4. browser_evaluate でスクロールして要素を表示
```

**再試行パターン:**
```
最大リトライ: 3回
リトライ間隔: 1-2秒
各リトライ前: スナップショット再取得
```

### 2. タイムアウト (Timeout)

**原因:**
- ページの読み込みが遅い
- ネットワーク問題
- サーバー応答なし
- 待機条件が満たされない

**対処:**
```
1. タイムアウト時間を延長
2. browser_wait_for の条件を見直し
3. ネットワーク状態を確認
4. 部分的な読み込みで続行
```

### 3. ナビゲーションエラー (Navigation Failed)

**原因:**
- URL が間違っている
- リダイレクトループ
- サイトがダウン
- SSL エラー

**対処:**
```
1. URL の形式を確認（https:// 付きか）
2. 別のブラウザで手動アクセスを試す
3. リダイレクト先 URL を確認
4. エラーをユーザーに報告
```

### 4. クリックがインターセプトされる (Click Intercepted)

**原因:**
- オーバーレイ/モーダルが表示されている
- 別の要素が重なっている
- Cookie 同意バナー
- ローディングスピナー

**対処:**
```
1. browser_snapshot で重なっている要素を確認
2. オーバーレイを閉じる（閉じるボタンをクリック）
3. browser_handle_dialog でダイアログを処理
4. browser_wait_for でローディング完了を待機
```

### 5. 認証エラー (Authentication Failed)

**原因:**
- 認証情報が間違っている
- セッションが切れた
- 2FA が必要
- CAPTCHA が表示された

**対処:**
```
1. 認証情報を再確認（ユーザーに確認）
2. ログイン手順を最初から再実行
3. 2FA/CAPTCHA はユーザーに通知
4. Real Chrome モードを検討
```

### 6. JavaScript エラー (Script Error)

**原因:**
- browser_evaluate のコードにエラー
- ページの JavaScript と競合
- 対象要素が存在しない

**対処:**
```
1. 実行するコードの構文を確認
2. 対象要素の存在を事前確認
3. try-catch でエラーをキャッチ
4. 代替手段（スナップショットから手動抽出）
```

## エラー復旧戦略

### 自動リトライ

```json
{
  "retryConfig": {
    "maxRetries": 3,
    "retryDelay": 1000,
    "retryableErrors": [
      "element_not_found",
      "timeout",
      "navigation_timeout"
    ]
  }
}
```

### フォールバック

```
1. 主要な方法が失敗
   ↓
2. 代替方法を試行
   ↓
3. 部分的な結果を返す
   ↓
4. エラーをユーザーに報告
```

### 状態回復

```
1. エラー発生
   ↓
2. browser_snapshot で現在の状態を確認
   ↓
3. 安全な状態に戻る（ホームページなど）
   ↓
4. 操作を再開または終了
```

## エラー報告

### ユーザーへの報告内容

```markdown
## エラーが発生しました

**エラー種別:** 要素が見つかりませんでした
**発生場所:** ログインボタンのクリック
**試行回数:** 3回

### 状況
- ページは正常に読み込まれました
- ログインフォームは表示されています
- 「ログイン」ボタンが見つかりませんでした

### 考えられる原因
- ボタンのテキストが異なる可能性
- ボタンが別の要素に置き換わっている可能性

### スクリーンショット
[添付]

### 推奨アクション
1. ページ構造を確認してボタンのセレクタを特定
2. 手動でボタンの位置を確認
```

## デバッグ用ツール

### スナップショット取得

```
browser_snapshot
```

ページのアクセシビリティツリーを取得して構造を確認。

### スクリーンショット取得

```
browser_take_screenshot { "type": "png" }
```

現在の画面状態を視覚的に確認。

### コンソールログ確認

```
browser_console_messages { "level": "error" }
```

JavaScript エラーを確認。

### ネットワークリクエスト確認

```
browser_network_requests { "includeStatic": false }
```

API 呼び出しの成否を確認。
