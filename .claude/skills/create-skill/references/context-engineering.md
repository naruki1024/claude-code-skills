# コンテキストエンジニアリング

## 定義

> LLMがタスクをちゃんと完走できるように、「どの情報」「どのツール」を「どのタイミング」で渡すかを設計すること

プロンプトを一発で書き切るのではなく、ワークフロー全体の中で「コンテキストの出し入れ」をデザインする発想。

## コンテキストウィンドウの構成

Claude Codeのコンテキストウィンドウ（最大20万トークン）:

| 領域 | 割合 | 内容 |
|------|------|------|
| システムプロンプト | 1.4% | Claude Codeの基本指示 |
| システムツール | 9.7% | 利用可能なツール定義 |
| Auto Compactバッファ | 22.5% | 自動圧縮用の余裕 |
| ユーザー利用可能 | 残り | 実際の作業領域 |

## コンテキストに常駐するもの

- CLAUDE.md
- MCPサーバー
- カスタムエージェント（.claude/agents/）
- カスタムスラッシュコマンド

## コンテキストを占有しないもの

- **Hooks**
- **Agent Skills** ← これが重要

## Skillsの段階的ロード

1. **Discovery**: スキルのメタデータ（name, description）のみ
2. **Loading**: SKILL.md の内容
3. **Execution**: agents/*.md と必要な references/ をTask実行直前にロード

## Taskによるコンテキスト分離

```
メインエージェント（オーケストレーター）
├── 独立したコンテキスト（約200kトークン）
│
├─→ Task A を起動
│   └── 独立したコンテキスト → 結果だけ返して消滅
│
├─→ Task B を起動
│   └── 独立したコンテキスト → 結果だけ返して消滅
│
└─→ Task C を起動
    └── 独立したコンテキスト → 結果だけ返して消滅
```

**効果**: メインエージェントのコンテキストは最後までスカスカに保てる

## スラッシュコマンドとの本質的な違い

| 仕組み | やっていること |
|--------|----------------|
| スラッシュコマンド | メインのコンテキストに「プロンプトや知識を追加する」 |
| Skills + Task | 「処理そのものを別コンテキストに分離して、結果だけ戻す」 |

## 設計指針

1. **メインエージェントは司令塔に徹する**
   - 重たい作業はTaskに丸投げ
   - 結果の判断と次のアクションの決定に集中

2. **フェーズごとにコンテキストを入れ替える**
   - リサーチ → 執筆 → レビュー を別Taskで実行
   - 各フェーズの履歴は他に影響させない

3. **「何を見せないか」も設計する**
   - 不要な情報はコンテキストに載せない
   - Taskの出力は要約だけをメインに返す
